# OR換班助手

## 簡介

「OR換班助手」旨在提供一個專為手術室 (OR) 環境設計的智慧排班與換班管理工具。本應用程式目標是簡化複雜的換班流程，視覺化呈現班表，輔助管理者進行有效的排班決策，並確保人力安排符合手術室運作需求與相關規定。

## 功能

### 1. 員工管理

*   **新增員工：** 管理者可以新增員工，只需記錄員工姓名。
*   **編輯員工資訊：** 管理者可以修改員工姓名。
*   **刪除員工：** 管理者可以刪除不再需要的員工。
*   **員工列表：** 顯示所有員工的列表，方便管理者查看和搜尋。

### 2. 班別管理

*   **班別類型：**
    *   白班 (07:30-15:30)
    *   配器械班 (07:30-17:30)
    *   小夜班 (15:00-23:00)
    *   大夜班 (23:00-08:00)
    *   12-8 班 (12:00-20:00)
    *   9-5 班 (09:00-17:00)
    *   白班待命 (07:00-15:00)
    *   小夜待命 (15:00-23:00)
    *   大夜待命 (23:00-07:00)
    *   Off日待 (07:00-19:00)
    *   Off夜待 (19:00-07:00)
    *   休假
    *   例假
*   **班別設定：** 系統預設班別時間，管理者可以根據需求調整。
*   **班別列表：** 顯示所有班別的列表，包含班別名稱和對應時間，方便管理者查看和管理。
*   **待命班別說明：**
    *   待命班別不計入工作時間
    *   待命期間如需要出勤，需另外記錄實際出勤時間
    *   待命班別可以與其他班別重疊
*   **特殊情況備註：**
    *   加班：
        *   白班加班：+1 ~ +20（例如：白班+1、白班+2等）
        *   小夜加班：+1 ~ +4（例如：小夜+1、小夜+2等）
    *   值班：值5 ~ 值8（例如：值5、值6等）
    *   假日班別：
        *   假日白班：D1 ~ D8
        *   假日小夜：D1 ~ D8
        *   假日大夜：D1 ~ D8
    *   備註格式：班別名稱 + 特殊情況（例如：白班+1、小夜值5、假日白班D1）

### 3. 排班功能

*   **建立排班表：** 管理者可以建立指定月份的排班表。
*   **自動排班：** 系統可以根據預設規則自動安排員工的班別（測試用）。
*   **手動排班：** 管理者可以點擊日期旁的「+」按鈕，為該日新增員工班別。
*   **排班編輯模式：**
    *   點擊「編輯班表」按鈕進入編輯模式。
    *   編輯模式下，班別方塊旁會顯示刪除按鈕「x」。
    *   編輯模式下，可以拖動班別方塊來觸發換班。
*   **換班功能 (拖放實現)：**
    *   在編輯模式下，將員工 A 在日期 X 的班別拖放到員工 B 在日期 Y 的班別上。
    *   系統會彈出確認視窗，顯示交換的詳細資訊。
    *   確認後，系統會檢查交換後的排班是否違反規則 (間隔、七休二、重複排班等)。
    *   若無違反規則，則執行交換：A 在 X 日的班別變為 B 原本在 X 日的班別，B 在 X 日變為 A 原本在 X 日的班別；同時 A 在 Y 日變為 B 原本在 Y 日的班別，B 在 Y 日變為 A 原本在 Y 日的班別 (即兩人在兩天班別完全互換)。
    *   若違反規則，則顯示錯誤訊息並取消交換。
*   **排班規則：**
    *   每7天內必須安排2天休假（1天休假 + 1天例假）
    *   相鄰班別之間必須間隔12小時以上
    *   系統會自動檢查並提示違反規則的排班
*   **排班衝突檢查：** 系統可以檢查排班表中是否存在衝突，例如同一員工在同一時間被安排了多個班別。
*   **複製排班表：** 管理者可以複製現有的排班表，以快速建立新的排班表。
*   **換班記錄：**
    *   系統會自動記錄所有成功的換班操作，包含時間、交換的雙方及班別資訊。
    *   在頁面下方會顯示換班歷史紀錄列表。
    *   (詳細記錄原始排班、換班原因、換班規則檢查、歷史查詢、匯出等功能待規劃)

### 4. 報表與匯出

*   **排班報表：** 產生各種排班報表，例如員工工作時數報表、班別覆蓋率報表等。
*   **班別統計標示：** 在班別統計表格中，若員工當月的小夜班或大夜班天數達到或超過 15 天（達成包班條件），其對應數字將以橘色字體標示。
*   **資料匯出：** 將排班資料匯出為 CSV 或 Excel 格式，方便進行進一步的分析和處理。

## 技術架構

*   **前端：** React
    *   使用 React 框架建立使用者介面
    *   使用 React Router 進行路由管理
    *   使用 Material-UI 或 Ant Design 建立美觀的使用者介面
    *   使用 React Query 管理 API 請求狀態
    *   使用 React Hook Form 處理表單
    *   使用 Jest 和 React Testing Library 進行單元測試

*   **後端：** React
    *   使用 React 框架建立後端 API
    *   使用 Express.js 作為 Web 伺服器
    *   使用 MongoDB 作為資料庫
    *   使用 JWT 進行身份認證
    *   使用 Jest 進行單元測試

*   **資料庫：** MongoDB
    *   使用 MongoDB 儲存員工、班別和排班資料
    *   使用 Mongoose 進行資料庫操作
    *   使用 MongoDB Compass 進行資料庫管理

*   **開發工具：**
    *   Git 版本控制
    *   Docker 容器化部署
    *   GitHub Actions CI/CD
    *   ESLint 和 Prettier 程式碼格式化
    *   Husky 和 lint-staged 確保程式碼品質

## 開發計畫

*   **第一階段：員工管理和班表建立 (已完成)**
    *   **員工管理：**
        *   新增員工
        *   編輯員工資訊
        *   刪除員工
        *   顯示員工列表
    *   **班表管理：**
        *   新增班表
        *   刪除班表
        *   視覺化呈現整個月份所有員工的班表

*   **第二階段：換班功能與規則完善 (進行中)**
    *   **點擊式換班功能：**
        *   取代原有的拖放換班，改為點擊觸發。
        *   第一步：選擇來源班別和想換成的新班別。
        *   第二步：高亮顯示有效的交換目標，點擊目標進行確認。
        *   換班時檢查間隔、休假等規則。
        *   記錄換班歷史。
    *   **排班規則檢查：**
        *   完善 `validateScheduleRules` 函數。
        *   提供獨立的「檢查規則」按鈕及結果顯示。
    *   **測試班表生成優化：**
        *   持續改進 `generateTestSchedule` 函數，使其更符合排班規則。

*   **第三階段：報表與進階功能 (待規劃)**
    *   **報表功能：**
        *   開發統計報表 (工時、班別覆蓋率等)。
        *   資料匯出功能 (CSV/Excel)。
    *   **進階功能：**
        *   資料持久化儲存 (例如連接後端 API 或使用 Local Storage)。
        *   使用者權限管理 (如果需要多人協作)。
        *   複製排班表功能。

## 未來功能展望 (待辦)

*   **多人換班機制：** 研究並實作支援三角換班或更複雜的多人換班鏈功能，以提高排班彈性。
*   **釐清特殊班別細節 (TO ASK / TODO)：**
    *   確認「待命班別」(Off日待、Off夜待等) 及「假日班別」(假日白班、假日小夜等) 是否有綁定特定的服務線或科別 (特殊線別)。
    *   這將影響相關的排班規則、統計計算及換班限制的設計，需在進一步開發前釐清。
*   **自訂排班規則：** 允許管理者根據實際需求調整或新增排班規則。
*   **班別備註功能增強：** 更完善地處理加班、值班、假日班等特殊備註的輸入與統計。
*   **使用者介面與體驗持續優化：** 根據使用者回饋進行調整。
*   **多人員間接換班機制**：開發一個更進階的換班系統，允許透過一系列的間接交換（例如 A->B, B->C, C->A）來滿足更複雜的換班需求。
*   **確認待命/例假班別的特殊線別**：在進行相關規則檢查、統計計算和換班限制設計前，需先釐清待命班與例假班是否綁定特定線別服務。
*   **修正行事曆捲動問題**：調整 `Schedule.tsx` 中外層容器 (`Paper`) 和內層內容 (`Box`, `TableContainer`) 的樣式，解決行事曆表格被垂直壓縮的問題，確保外層容器處理捲動，行事曆能完整顯示。

## 如何貢獻

歡迎大家參與本專案的開發！您可以透過以下方式貢獻：

*   提交 Issue：報告 Bug 或提出新的功能建議。
*   提交 Pull Request：修復 Bug 或新增功能。

## 授權

本專案採用 [Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License (CC BY-NC-ND 4.0)](https://creativecommons.org/licenses/by-nc-nd/4.0/) 授權。

這表示您可以：
- 分享 — 以任何媒介或格式重製及散布本素材

但需要遵守以下條件：
- 姓名標示 — 您必須給予適當表彰、提供指向本授權條款的連結，以及指出（本作品的原始版本）是否已被變更。
- 非商業性 — 您不得將本素材進行商業目的之使用。
- 禁止改作 — 若您重混、轉換本素材，或依本素材建立新素材，則您不得散布改作後的素材。

## 開發歷史紀錄

### 2025-04-01 功能優化、修正與換班流程重構
1. 環境設定與啟動
   - 解決 `npm start` 執行錯誤，確保專案可在開發環境正常啟動。
   - 修正 `nvm` 使用問題，確保 Node.js 版本正確。
2. 佈局調整與規則顯示
   - 修正排班規則檢查結果區塊遮擋下方行事曆的問題。
   - 將規則檢查結果改為彈出式視窗 (Dialog) 顯示，優化使用者體驗並簡化佈局。
3. 統計功能修正與增強
   - 修正班別統計在「生成測試班表」後未即時更新的問題。
   - 新增包班條件標示：當月小夜班或大夜班 >= 15 天時，統計數字以橘色顯示。
   - 新增「總上班天數」統計欄位，並在天數 < 11 時以紅色標示。
4. 測試班表生成優化 (持續改進中)
   - 「生成測試班表」功能現在會納入排班規則（七休二、12小時間隔）。
   - 改善休息日分配的隨機性，避免過於集中，並盡量確保每位員工工作班數 > 11 天。
   - 修正月初生成班表時因缺乏歷史數據導致規則判斷錯誤的問題。
   - 為方便測試包班標示，加入讓特定員工優先排大小夜的邏輯。
   - 多次嘗試調整 `generateTestSchedule` 函數邏輯，以期更符合七天休假、例假及每日休假人數上限等規則，但仍有待完善。
5. **換班功能重構 (點擊式):**
   - 移除原有的拖放換班機制。
   - 實作新的點擊式兩階段換班流程：
     1. 點擊來源班別 -> 選擇想換成的新班別。
     2. 系統高亮有效目標 -> 點擊目標班別 -> 確認交換。
6. **換班流程優化:**
   - 在選擇新班別後，增加檢查步驟，確保至少存在一個有效的交換目標才進入下一步。
   - 若無有效目標，彈出提示訊息並中止換班流程。
   - 在選擇目標階段，視覺上高亮來源班別，並將無效目標（來源員工其他班、交換後違規的班）變灰且禁止點擊。
7. **介面樣式調整:**
   - 非編輯模式下，班別文字置中；編輯模式下靠左。
   - 重新設計刪除按鈕 (x)，將其縮小並置於右上角，減少視覺干擾。
8. **換班歷史紀錄:**
   - 更新歷史紀錄格式，採用「原班別 → 新班別」的顯示方式，提高可讀性。
9. **新增班別流程簡化:**
   - 移除「新增班別」對話框中即時的「七天休假規則」檢查，回歸由獨立的「檢查規則」按鈕統一處理。
10. **員工資料結構擴充:**
    - 為 `Employee` interface 新增 `specialty` (專科) 欄位，包含 `'OPH'`, `'CVS'`, `'OPH+CVS'`, `'非專OPH'`, `'非專CVS'`, `'新人'` 等選項。
    - 更新所有相關元件 (`App`, `Schedule`, `EmployeeManagement`, `EmployeeFormDialog`) 中的 `Employee` 定義以保持一致。
11. **介面更新 (員工專科):**
    - 在排班頁面左側員工列表和員工管理頁面的表格中顯示員工的專科資訊。
    - 更新「新增/編輯員工」對話框，加入選擇員工專科的下拉選單。
12. **類型錯誤修正:**
    - 解決因 `Employee` interface 定義不一致導致的多個 TypeScript 編譯錯誤。
13. **待辦事項記錄:**
    - 在 README 中記錄待辦事項，需釐清待命及假日班別的特殊線別問題。

### 2025-03-25 功能開發進度
1. 基礎功能建置
   - 建立月曆視圖，支援月份切換
   - 實作員工管理基本功能
   - 完成班別管理系統設計

2. 排班功能實作
   - 支援多種班別：
     - 一般班別：白班、小夜班、大夜班、12-8班、9-5班
     - 待命班別：白班待命、小夜待命、大夜待命、Off日待、Off夜待
     - 休假類型：休假、例假

3. 排班規則實作
   - 相鄰班別時間間隔檢查
     - 確保班別之間至少間隔 12 小時
     - 自動禁用不符合時間間隔的班別選項
   - 休假規則檢查
     - 每 7 天必須安排 1 天休假
     - 每 7 天必須安排 1 天例假
     - 在排班時自動檢查並提示

4. 排班管理功能
   - 新增排班
     - 可選擇員工和班別
     - 即時檢查排班規則
     - 防止重複排班
   - 刪除排班
     - 帶有確認對話框
     - 清楚顯示要刪除的排班資訊
     - 防止誤刪：需先點擊「編輯班表」按鈕進入編輯模式，班別旁才會顯示刪除按鈕。

5. 使用者介面優化
   - 月曆視圖
     - 清晰的日期顯示
     - 跨月份日期的特殊處理
     - 自適應的格子大小
   - 排班顯示
     - 直觀的排班資訊展示
     - 互動式的刪除按鈕
     - 懸停效果增強可讀性

6. 待開發功能
   - 資料持久化儲存
   - 排班資料匯出功能
   - 更多的排班規則檢查
   - 排班統計報表 